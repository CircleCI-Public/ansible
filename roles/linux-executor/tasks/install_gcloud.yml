# !file: roles/linux-executor/tasks/install_gcloud.yml

- block:
    - name: Create /opt/google directory
      file:
        path: "/opt/google"
        state: directory

    - name: Download gcloud
      get_url:
        url: "https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-{{ gcloud_version }}-linux-x86_64.tar.gz"
        dest: "/tmp/gcloud.tar.gz"

    - name: Extract gcloud
      unarchive:
        src: "/tmp/gcloud.tar.gz"
        dest: "/opt/google"

    - name: Change ownership of /opt/google
      file:
        path: "/opt/google"
        owner: "{{ circleci_user }}"
        group: "{{ circleci_user }}"
        state: directory
        recurse: yes

    - name: Configure gcloud
      shell: |
        /opt/google/google-cloud-sdk/bin/gcloud config set --installation component_manager/disable_update_check true
        /opt/google/google-cloud-sdk/bin/gcloud config set disable_usage_reporting false

    - name: Make /.config directory
      file:
        path: "{{ circleci_home }}/.config"
        state: directory

    - name: Change ownership of /.config directory
      file:
        path: "{{ circleci_home }}/.config"
        owner: "{{ circleci_user }}"
        group: "{{ circleci_user }}"
        state: directory
        recurse: yes

    - name: Set gcloud path
      lineinfile:
        path: "{{ circleci_home }}/.circlerc"
        line: "export PATH=/opt/google/google-cloud-sdk/bin:$PATH"
        create: yes

  become: true
  become_method: sudo

- name: Configure gcloud
  shell: |
    /opt/google/google-cloud-sdk/bin/gcloud config set --installation component_manager/disable_update_check true
    /opt/google/google-cloud-sdk/bin/gcloud config set disable_usage_reporting false
  become_user: "{{ circleci_user }}"
  become: true
