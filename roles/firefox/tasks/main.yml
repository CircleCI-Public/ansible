---
- block:
  - name: Add mozilla ppa
    ansible.builtin.apt_repository:
      repo: "ppa:mozillateam/ppa"
      state: present

  # Because 22.04 now uses snap, these removals and resetting of repositories is needed to download firefox
  - name: Disable snaps
    ansible.builtin.shell:
      sudo systemctl disable {{ item }}
    with_items: "{{ snap_services }}"

  - name: List snaps
    ansible.builtin.shell:
      sudo snap list

  - name: Remove snaps
    ansible.builtin.shell:
      snap remove {{ item }}
    with_items: "{{ snaps }}"

  - name: Fully remove and purge snapd
    ansible.builtin.shell:
      apt purge --autoremove "{{ item }}"
    with_items: "{{ snapd_prefs }}"

  - name: Blacklist snap firefox
    ansible.builtin.blockinfile:
      path: "/etc/apt/preferences"
      create: yes
      block: |
        Package: firefox
        Pin: version 1:1snap1-0ubuntu2
        Pin-Priority: -1

  - name: Clean up snap directories
    ansible.builtin.file:
      path: "{{ item }}"
      state: absent
    with_items: "{{ snap_dirs }}"

  - name: Prioritze apt/debian download of firefox
    ansible.builtin.blockinfile:
      path: "/etc/apt/preferences.d/mozilla-firefox"
      marker_begin: "FIREFOX START"
      marker_end: "FIREFOX END"
      create: yes
      block: |
        Package: *
        Pin: release o=LP-PPA-mozillateam
        Pin-Priority: 1001

  - name: Install firefox
    ansible.builtin.apt:
      pkg: "firefox"
      state: present
      update_cache: yes
      allow_downgrade: true

  become: true
